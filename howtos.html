

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How-Tos &mdash; Scalable Vector Search 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/sphinx_collapse.css?v=226d88b4" />
      <link rel="stylesheet" type="text/css" href="_static/css/custom.css" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=d45e8c67"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="I/O and Conversion Tools" href="io.html" />
    <link rel="prev" title="Library Features" href="features.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Scalable Vector Search
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="start.html">Getting started with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="start_cpp.html">Getting started with C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="features.html">Library Features</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">How-Tos</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#how-to-do-dynamic-indexing">How to Do Dynamic Indexing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#generating-test-data">Generating test data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#building-the-dynamic-index">Building the Dynamic Index</a></li>
<li class="toctree-l3"><a class="reference internal" href="#updating-the-index">Updating the index</a></li>
<li class="toctree-l3"><a class="reference internal" href="#searching-the-index">Searching the Index</a></li>
<li class="toctree-l3"><a class="reference internal" href="#saving-the-index">Saving the Index</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reloading-a-saved-index">Reloading a Saved Index</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-choose-graph-building-hyper-parameters">How to Choose Graph Building Hyper-parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-set-the-search-window-size">How to Set the Search Window Size</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-choose-compression-parameters">How to Choose Compression Parameters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#number-of-bits-per-level">Number of bits per level</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lvq-implementation-strategy">LVQ implementation strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#padding">Padding</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-prepare-your-own-vector-dataset">How to Prepare Your Own Vector Dataset</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example-vector-embeddings-of-images">Example: vector embeddings of images</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#select-embedding-model">Select embedding model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#preprocess-the-data">Preprocess the data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#embed-the-data-to-generate-vectors">Embed the data to generate vectors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use-or-save-the-embeddings">Use or save the embeddings</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="io.html">I/O and Conversion Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="performance/index.html">Performance Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced/index.html">Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchs/index.html">Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="python/common.html">Common Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="python/loaders.html">Loaders</a></li>
<li class="toctree-l1"><a class="reference internal" href="python/flat.html">Flat Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="python/vamana.html">Vamana Graph Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="python/dynamic.html">Dynamic Vamana Graph Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="python/backend.html">Backend Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="python/upgrader.html">Object Upgrader</a></li>
<li class="toctree-l1"><a class="reference internal" href="python/logging.html">Python Logging API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">C++ Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cpp/top.html">C++ Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp/index/index.html">Indexes</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp/core/index.html">Core Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp/quantization/index.html">Quantization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp/concepts/index.html">Core Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp/internal/index.html">Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp/testing.html">Testing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Experimental Python Library</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="python/experimental/leanvec.html">Using LeanVec</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Scalable Vector Search</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">How-Tos</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/howtos.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="how-tos">
<span id="howtos"></span><h1>How-Tos<a class="headerlink" href="#how-tos" title="Link to this heading"></a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#how-to-do-dynamic-indexing" id="id3">How to Do Dynamic Indexing</a></p></li>
<li><p><a class="reference internal" href="#how-to-choose-graph-building-hyper-parameters" id="id4">How to Choose Graph Building Hyper-parameters</a></p></li>
<li><p><a class="reference internal" href="#how-to-set-the-search-window-size" id="id5">How to Set the Search Window Size</a></p></li>
<li><p><a class="reference internal" href="#how-to-choose-compression-parameters" id="id6">How to Choose Compression Parameters</a></p></li>
<li><p><a class="reference internal" href="#how-to-prepare-your-own-vector-dataset" id="id7">How to Prepare Your Own Vector Dataset</a></p></li>
</ul>
</nav>
<section id="how-to-do-dynamic-indexing">
<span id="how-to-run-dynamic-indexing"></span><h2><a class="toc-backref" href="#id3" role="doc-backlink">How to Do Dynamic Indexing</a><a class="headerlink" href="#how-to-do-dynamic-indexing" title="Link to this heading"></a></h2>
<p>This tutorial will show you how to create a dynamic index, add and remove vectors, search the index, save and reload it.</p>
<section id="generating-test-data">
<h3>Generating test data<a class="headerlink" href="#generating-test-data" title="Link to this heading"></a></h3>
<p>We generate a sample dataset using the <a class="reference internal" href="python/common.html#svs.generate_test_dataset" title="svs.generate_test_dataset"><code class="xref py py-func docutils literal notranslate"><span class="pre">svs.generate_test_dataset()</span></code></a> generation function.
This function generates a data file, a query file, and the ground truth. Note that this is randomly generated data,
with no semantic meaning for the elements within it.</p>
<p>We first load svs and other modules required for this example.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">svs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</pre></div>
</div>
<p>Then proceed to generate the test dataset.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a test dataset.</span>
<span class="c1"># This will create a directory &quot;example_data_vamana&quot; and populate it with three</span>
<span class="c1"># entries:</span>
<span class="c1"># - data.fvecs: The test dataset.</span>
<span class="c1"># - queries.fvecs: The test queries.</span>
<span class="c1"># - groundtruth.ivecs: The groundtruth.</span>
<span class="n">test_data_dir</span> <span class="o">=</span> <span class="s2">&quot;./example_data_vamana&quot;</span>
<span class="n">svs</span><span class="o">.</span><span class="n">generate_test_dataset</span><span class="p">(</span>
    <span class="mi">10000</span><span class="p">,</span>                      <span class="c1"># Create 10000 vectors in the dataset.</span>
    <span class="mi">1000</span><span class="p">,</span>                       <span class="c1"># Generate 1000 query vectors.</span>
    <span class="mi">128</span><span class="p">,</span>                        <span class="c1"># Set the vector dimensionality to 128.</span>
    <span class="n">test_data_dir</span><span class="p">,</span>              <span class="c1"># The directory where results will be generated.</span>
    <span class="n">data_seed</span> <span class="o">=</span> <span class="mi">1234</span><span class="p">,</span>           <span class="c1"># Random number seed for reproducibility.</span>
    <span class="n">query_seed</span> <span class="o">=</span> <span class="mi">5678</span><span class="p">,</span>          <span class="c1"># Random number seed for reproducibility.</span>
    <span class="n">num_threads</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>            <span class="c1"># Number of threads to use.</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">svs</span><span class="o">.</span><span class="n">DistanceType</span><span class="o">.</span><span class="n">L2</span><span class="p">,</span>   <span class="c1"># The distance type to use.</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="building-the-dynamic-index">
<h3>Building the Dynamic Index<a class="headerlink" href="#building-the-dynamic-index" title="Link to this heading"></a></h3>
<p>To construct the index we first need to define the hyper-parameters for the graph construction
(see <a class="reference internal" href="#graph-build-param-setting"><span class="std std-ref">How to Choose Graph Building Hyper-parameters</span></a> for details).</p>
<p><strong>In Python</strong></p>
<p>This is done by creating an instance of <a class="reference internal" href="python/vamana.html#svs.VamanaBuildParameters" title="svs.VamanaBuildParameters"><code class="xref py py-class docutils literal notranslate"><span class="pre">svs.VamanaBuildParameters</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">parameters</span> <span class="o">=</span> <span class="n">svs</span><span class="o">.</span><span class="n">VamanaBuildParameters</span><span class="p">(</span>
    <span class="n">graph_max_degree</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
    <span class="n">window_size</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Now that we’ve established our hyper-parameters, it is time to construct the index. For this, we load the data and
build the dynamic index with the first 9k vectors of the dataset.</p>
<p><strong>In Python</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">9000</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">svs</span><span class="o">.</span><span class="n">read_vecs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_data_dir</span><span class="p">,</span> <span class="s2">&quot;data.fvecs&quot;</span><span class="p">))</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint64&#39;</span><span class="p">)</span>

<span class="n">index</span> <span class="o">=</span> <span class="n">svs</span><span class="o">.</span><span class="n">DynamicVamana</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
    <span class="n">parameters</span><span class="p">,</span>
    <span class="n">data</span><span class="p">[:</span><span class="n">n</span><span class="p">],</span>
    <span class="n">idx</span><span class="p">[:</span><span class="n">n</span><span class="p">],</span>
    <span class="n">svs</span><span class="o">.</span><span class="n">DistanceType</span><span class="o">.</span><span class="n">L2</span><span class="p">,</span>
    <span class="n">num_threads</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="updating-the-index">
<h3>Updating the index<a class="headerlink" href="#updating-the-index" title="Link to this heading"></a></h3>
<p>Once we’ve built the initial dynamic index, we can add and remove vectors.</p>
<p><strong>In Python</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add the following 1000 vectors to the index.</span>
<span class="n">index</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="mi">1000</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="mi">1000</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove the first 100 vectors from the index.</span>
<span class="n">index</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">[:</span><span class="mi">100</span><span class="p">])</span>
</pre></div>
</div>
<p>Deletions are performed in a lazy fashion to avoid an excessive compute overhead. When a vector is deleted, it is added
to a list of deleted elements but not immediately removed from the index. At search time, it is used during graph
traversal but it is filtered out from the nearest neighbors result.
Once a sufficient number of deletions is accumulated the <code class="docutils literal notranslate"><span class="pre">consolidate()</span></code> and <code class="docutils literal notranslate"><span class="pre">compact()</span></code> functions should be ran to
effectively remove the vectors from the index.</p>
<p><strong>In Python</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Consolidate the index.</span>
<span class="n">index</span><span class="o">.</span><span class="n">consolidate</span><span class="p">()</span><span class="o">.</span><span class="n">compact</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="searching-the-index">
<h3>Searching the Index<a class="headerlink" href="#searching-the-index" title="Link to this heading"></a></h3>
<p>First, we load the queries and the computed ground truth for our example dataset.</p>
<p><strong>In Python</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the queries and ground truth.</span>
<span class="n">queries</span> <span class="o">=</span> <span class="n">svs</span><span class="o">.</span><span class="n">read_vecs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_data_dir</span><span class="p">,</span> <span class="s2">&quot;queries.fvecs&quot;</span><span class="p">))</span>
<span class="n">groundtruth</span> <span class="o">=</span> <span class="n">svs</span><span class="o">.</span><span class="n">read_vecs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_data_dir</span><span class="p">,</span> <span class="s2">&quot;groundtruth.ivecs&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>Then, run the search in the same fashion as for the static graph.</p>
<p><strong>In Python</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the search window size of the index and perform queries.</span>
<span class="n">index</span><span class="o">.</span><span class="n">search_window_size</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">I</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">queries</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1"># Compare with the groundtruth.</span>
<span class="n">recall</span> <span class="o">=</span> <span class="n">svs</span><span class="o">.</span><span class="n">k_recall_at</span><span class="p">(</span><span class="n">groundtruth</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall = </span><span class="si">{</span><span class="n">recall</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">assert_equal</span><span class="p">(</span><span class="n">recall</span><span class="p">,</span> <span class="mf">0.8202</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="saving-the-index">
<h3>Saving the Index<a class="headerlink" href="#saving-the-index" title="Link to this heading"></a></h3>
<p>If you are satisfied with the performance of the generated index, you can save it to disk to avoid rebuilding it in the future.</p>
<p><strong>In Python</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Finally, we can save the results.</span>
<span class="n">index</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_data_dir</span><span class="p">,</span> <span class="s2">&quot;example_config&quot;</span><span class="p">),</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_data_dir</span><span class="p">,</span> <span class="s2">&quot;example_graph&quot;</span><span class="p">),</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_data_dir</span><span class="p">,</span> <span class="s2">&quot;example_data&quot;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The save index function currently uses three folders for saving.
All three are needed to be able to reload the index.</p>
<ul class="simple">
<li><p>One folder for the graph.</p></li>
<li><p>One folder for the data.</p></li>
<li><p>One folder for metadata.</p></li>
</ul>
<p>This is subject to change in the future.</p>
</div>
</section>
<section id="reloading-a-saved-index">
<h3>Reloading a Saved Index<a class="headerlink" href="#reloading-a-saved-index" title="Link to this heading"></a></h3>
<p>To reload the index from file, use the corresponding constructor with the three folder names used to save the index.
Performing queries is identical to before.</p>
<p><strong>In Python</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can reload an index from a previously saved set of files.</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">svs</span><span class="o">.</span><span class="n">DynamicVamana</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_data_dir</span><span class="p">,</span> <span class="s2">&quot;example_config&quot;</span><span class="p">),</span>
    <span class="n">svs</span><span class="o">.</span><span class="n">GraphLoader</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_data_dir</span><span class="p">,</span> <span class="s2">&quot;example_graph&quot;</span><span class="p">)),</span>
    <span class="n">svs</span><span class="o">.</span><span class="n">VectorDataLoader</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_data_dir</span><span class="p">,</span> <span class="s2">&quot;example_data&quot;</span><span class="p">),</span> <span class="n">svs</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">float32</span>
    <span class="p">),</span>
    <span class="n">svs</span><span class="o">.</span><span class="n">DistanceType</span><span class="o">.</span><span class="n">L2</span><span class="p">,</span>
    <span class="n">num_threads</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Note that the second argument, the one corresponding to the file for the data, requires a <a class="reference internal" href="python/loaders.html#svs.VectorDataLoader" title="svs.VectorDataLoader"><code class="xref py py-class docutils literal notranslate"><span class="pre">svs.VectorDataLoader</span></code></a> and
the corresponding data type.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
<section id="how-to-choose-graph-building-hyper-parameters">
<span id="graph-build-param-setting"></span><h2><a class="toc-backref" href="#id4" role="doc-backlink">How to Choose Graph Building Hyper-parameters</a><a class="headerlink" href="#how-to-choose-graph-building-hyper-parameters" title="Link to this heading"></a></h2>
<p>The optimal values for the graph building hyper-parameters depend on the dataset and on the trade-off between performance and
accuracy that is required. We suggest here commonly used values and provide some guidance on how to adjust them. See
<a class="reference internal" href="advanced/graph_search.html#graph-building-details"><span class="std std-ref">How does graph building work?</span></a> for more details about graph building.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">graph_max_degree</span></code>: Maximum out-degree of the graph. A larger <code class="docutils literal notranslate"><span class="pre">graph_max_degree</span></code> implies more distance computations
per hop, but potentially a shorter graph traversal path, so it can lead to higher search performance. High-dimensional
datasets or datasets with a large number of points usually require a larger <code class="docutils literal notranslate"><span class="pre">graph_max_degree</span></code> to reach very high search accuracy.
Keep in mind that the graph size in bytes is given by 4 times <code class="docutils literal notranslate"><span class="pre">graph_max_degree</span></code>
(each neighbor id in the graph adjacency lists is represented with 4 bytes) times the number of points in the dataset,
so a larger <code class="docutils literal notranslate"><span class="pre">graph_max_degree</span></code> will have a larger memory footprint. Commonly used values for <code class="docutils literal notranslate"><span class="pre">graph_max_degree</span></code> are 32, 64 or 128.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alpha</span></code>: Threshold for the graph adjacency lists <a class="reference internal" href="advanced/graph_search.html#graph-pruning"><span class="std std-ref">pruning rule</span></a> during the second pass over the dataset. For
distance types favoring minimization, set this to a number greater than 1.0 to build a denser graph (typically, 1.2 is sufficient).
For distance types preferring maximization, set to a value less than 1.0 to build a denser graph (such as 0.95).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">window_size</span></code>: Sets the <code class="docutils literal notranslate"><span class="pre">search_window_size</span></code> for the graph search conducted to add new points to the graph. This
parameter controls the quality of <a class="reference internal" href="advanced/graph_search.html#graph-building-pseudocode"><span class="std std-ref">graph construction</span></a>. A larger window size will yield a higher-quality
index at the cost of longer construction time. Should be larger than <code class="docutils literal notranslate"><span class="pre">graph_max_degree</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_candidate_pool_size</span></code>: Limit on the number of candidates to consider for the graph adjacency lists <a class="reference internal" href="advanced/graph_search.html#graph-pruning"><span class="std std-ref">pruning rule</span></a>.
Should be larger than <code class="docutils literal notranslate"><span class="pre">window_size</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_threads</span></code>: The number of threads to use for index construction. The indexing process is highly parallelizable, so
using as many <code class="docutils literal notranslate"><span class="pre">num_threads</span></code> as possible is usually better.</p></li>
</ul>
</section>
<section id="how-to-set-the-search-window-size">
<span id="search-window-size-setting"></span><h2><a class="toc-backref" href="#id5" role="doc-backlink">How to Set the Search Window Size</a><a class="headerlink" href="#how-to-set-the-search-window-size" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">search_window_size</span></code> is the knob controlling the trade-off between performance and accuracy for the graph search.
A larger <code class="docutils literal notranslate"><span class="pre">search_window_size</span></code> implies exploring more vectors, improving the accuracy at the cost of a longer search path.
See <a class="reference internal" href="advanced/graph_search.html#graph-search-details"><span class="std std-ref">How does the graph search work?</span></a> for more details about graph search. One simple way to set the <code class="docutils literal notranslate"><span class="pre">search_window_size</span></code> is to run
searches with multiple values of the parameter and print the recall to identify the required <code class="docutils literal notranslate"><span class="pre">search_window_size</span></code> for
the chosen accuracy level.</p>
<p><strong>In Python</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can vary the search window size to demonstrate the trade off in accuracy.</span>
<span class="k">for</span> <span class="n">window_size</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
    <span class="n">index</span><span class="o">.</span><span class="n">search_window_size</span> <span class="o">=</span> <span class="n">window_size</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">queries</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">svs</span><span class="o">.</span><span class="n">k_recall_at</span><span class="p">(</span><span class="n">groundtruth</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Window size = </span><span class="si">{</span><span class="n">window_size</span><span class="si">}</span><span class="s2">, Recall = </span><span class="si">{</span><span class="n">recall</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>In C++</strong></p>
<div class="sphinx_collapse docutils container">
<input class="sphinx_collapse__input" id="f5785b9a-20d9-41bc-83a1-6ba62cae43f2" name="f5785b9a-20d9-41bc-83a1-6ba62cae43f2" type="checkbox"><label class="sphinx_collapse__label" for="f5785b9a-20d9-41bc-83a1-6ba62cae43f2"><i class="sphinx_collapse__icon"></i>Click to display</label><div class="sphinx_collapse__content docutils container">
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">expected_recall</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">&gt;</span><span class="p">({{</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5509</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mf">0.7281</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8215</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8788</span><span class="p">}});</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">windowsize</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">recall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run_recall</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">queries</span><span class="p">,</span><span class="w"> </span><span class="n">groundtruth</span><span class="p">,</span><span class="w"> </span><span class="n">windowsize</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Sweep&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">expected_recall</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">windowsize</span><span class="p">),</span><span class="w"> </span><span class="n">recall</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="how-to-choose-compression-parameters">
<span id="compression-setting"></span><h2><a class="toc-backref" href="#id6" role="doc-backlink">How to Choose Compression Parameters</a><a class="headerlink" href="#how-to-choose-compression-parameters" title="Link to this heading"></a></h2>
<section id="number-of-bits-per-level">
<h3>Number of bits per level<a class="headerlink" href="#number-of-bits-per-level" title="Link to this heading"></a></h3>
<p>LVQ compression <a class="reference internal" href="features.html#abht23" id="id1"><span>[ABHT23]</span></a> comes in two flavors: one or two levels. One level LVQ, or LVQ-B, uses B bits to encode each vector
component using a scalar quantization with per-vector scaling factors. Two level LVQ, or LVQ-B1xB2, uses LVQ-B1 to encode
the vectors and a modification of LVQ to encode the residuals using B2 bits.</p>
<p>Whether using one or two levels, and the number of bits, depends on the dataset and the trade-off between performance and
accuracy that needs to be achieved.</p>
<p>When using <strong>two-level LVQ</strong>, the graph search is conducted using vectors compressed with LVQ-B1 and a final re-ranking
step is performed using the residuals compressed with B2 bits to improve the search recall.
This decoupled strategy is particularly beneficial for <strong>high dimensional datasets</strong> (&gt;200 dimensions) as LVQ achieves up to
~8x bandwidth reduction (B1=4) compared to a float32-valued vector. The number of bits for the residuals (4 or 8) should
be chosen depending on the desired search accuracy. Suggested configurations for high dimensional vectors are LVQ-4x8 or
LVQ-4x4 depending on the desired accuracy.</p>
<p>For <strong>lower dimensional datasets</strong> (&lt;200 dimensions), <strong>one-level</strong> LVQ-8 is often a good choice. If higher recall is required, and a
slightly larger memory footprint is allowed, then LVQ-8x4 or LVQ-8x8 should be used.</p>
<p>These are general guidelines, but the best option will depend on the dataset. If willing to optimize the search for a
particular dataset and use case, we suggest trying different LVQ options. See <a class="reference internal" href="benchs/ablation.html#benchs-compression-evaluation"><span class="std std-ref">SVS + Vector compression (large scale
datasets)</span></a> and
<a class="reference internal" href="benchs/ablation.html#benchs-compression-evaluation-small-scale"><span class="std std-ref">SVS + Vector compression (small scale datasets)</span></a> for benchmarking results of
the different LVQ settings in standard datasets.</p>
</section>
<section id="lvq-implementation-strategy">
<span id="lvq-strategy"></span><h3>LVQ implementation strategy<a class="headerlink" href="#lvq-implementation-strategy" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">strategy</span></code> argument in the <code class="xref py py-class docutils literal notranslate"><span class="pre">svs.LVQLoader</span></code> is of type <code class="xref py py-class docutils literal notranslate"><span class="pre">svs.LVQStrategy</span></code>
and defines the low level implementation strategy for LVQ, whether it is Turbo or Sequential. Turbo is an
optimized implementation that brings further performance over the default (Sequential) implementation <a class="reference internal" href="features.html#ahbw24" id="id2"><span>[AHBW24]</span></a>. Turbo can be used
when using 4 bits for the primary LVQ level and it is enabled by default for that setting.</p>
</section>
<section id="padding">
<h3>Padding<a class="headerlink" href="#padding" title="Link to this heading"></a></h3>
<p>LVQ-compressed vectors can be padded to a multiple of 32 or 64 bytes to be aligned with half or full cache lines.
This improves search performance and has a low impact on the overall memory footprint cost (e.g., 5% and 12% larger
footprint for <a class="reference external" href="http://sites.skoltech.ru/compvision/noimi/">Deep</a> with <code class="docutils literal notranslate"><span class="pre">graph_max_degree</span></code> = 128 and 32, respectively).
A value of 0 (default) implies no special alignment.</p>
<p>For details on the C++ implementation see <a class="reference internal" href="cpp/quantization/lvq.html#cpp-quantization-lvq"><span class="std std-ref">Locally-Adaptive Vector Quantization</span></a>.</p>
</section>
</section>
<section id="how-to-prepare-your-own-vector-dataset">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">How to Prepare Your Own Vector Dataset</a><a class="headerlink" href="#how-to-prepare-your-own-vector-dataset" title="Link to this heading"></a></h2>
<p>Preparing your own vector dataset is simple with our Python API <code class="docutils literal notranslate"><span class="pre">svs</span></code>, which can
directly use embeddings encoded as <code class="docutils literal notranslate"><span class="pre">numpy</span></code> arrays.</p>
<p>There are 3 main steps to preparing your own vector dataset, starting from the original
data format (e.g. images, text).</p>
<ol class="arabic simple" start="0">
<li><p>Select embedding model</p></li>
<li><p>Preprocess the data</p></li>
<li><p>Embed the data to generate vectors</p></li>
<li><p>Use or save the embeddings</p></li>
</ol>
<p>We will walk through a simple example below. For complete examples, please
see our <a class="reference external" href="https://github.com/IntelLabs/VectorSearchDatasets">VectorSearchDatasets repository</a>, which contains code to generate compatible
vector embeddings for common datasets such as <a class="reference external" href="https://storage.googleapis.com/openimages/web/index.html">open-images</a>.</p>
<section id="example-vector-embeddings-of-images">
<h3>Example: vector embeddings of images<a class="headerlink" href="#example-vector-embeddings-of-images" title="Link to this heading"></a></h3>
<p>This simplified example is derived from our <a class="reference external" href="https://github.com/IntelLabs/VectorSearchDatasets/tree/main/openimages">VectorSearchDatasets</a> code.</p>
<section id="select-embedding-model">
<h4>Select embedding model<a class="headerlink" href="#select-embedding-model" title="Link to this heading"></a></h4>
<p>Many users will be interested in using deep learning models to embed their data. For an
image this could be something like the multimodal vision-language model, <a class="reference external" href="https://github.com/OpenAI/CLIP">CLIP</a>. This model is available through the
<a class="reference external" href="https://huggingface.co/docs/transformers/en/model_doc/clip">Hugging Face
Transformers library</a>,
which we import here in order to load the model. We also import PyTorch and some data
processing tools which will appear in the next step.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">svs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoProcessor</span><span class="p">,</span> <span class="n">CLIPProcessor</span><span class="p">,</span> <span class="n">CLIPModel</span>

<span class="n">model_str</span> <span class="o">=</span> <span class="s2">&quot;openai/clip-vit-base-patch32&quot;</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">CLIPModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_str</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="preprocess-the-data">
<h4>Preprocess the data<a class="headerlink" href="#preprocess-the-data" title="Link to this heading"></a></h4>
<p>You will need to prepare your data so that it can be processed by the embedding model.
You should also apply any other preprocessing here, such as cropping images, removing
extraneous text, etc.</p>
<p>For our example, let’s assume that the OpenImages dataset has been downloaded and we
wish to preprocess the first 24 images. Here we use the HuggingFace
AutoProcessor to pre-process the dataset to the format required by CLIP.</p>
<div class="sphinx_collapse docutils container">
<input class="sphinx_collapse__input" id="fdf93ec7-58f0-4a84-86ec-a591e321ff9c" name="fdf93ec7-58f0-4a84-86ec-a591e321ff9c" type="checkbox"><label class="sphinx_collapse__label" for="fdf93ec7-58f0-4a84-86ec-a591e321ff9c"><i class="sphinx_collapse__icon"></i>Click to display</label><div class="sphinx_collapse__content docutils container">
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>

<span class="n">processor</span> <span class="o">=</span> <span class="n">AutoProcessor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_str</span><span class="p">)</span>

<span class="n">image_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">n_img_to_process</span> <span class="o">=</span> <span class="mi">24</span>
<span class="k">for</span> <span class="n">img_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_img_to_process</span><span class="p">):</span>
    <span class="n">image_fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">oi_base_dir</span><span class="si">}</span><span class="s1">/images/</span><span class="si">{</span><span class="n">img_id</span><span class="si">}</span><span class="s1">.jpg&#39;</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_fname</span><span class="p">)</span>
    <span class="n">image_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pre-processing </span><span class="si">{</span><span class="n">n_img_to_process</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">processor</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="n">image_list</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="embed-the-data-to-generate-vectors">
<h4>Embed the data to generate vectors<a class="headerlink" href="#embed-the-data-to-generate-vectors" title="Link to this heading"></a></h4>
<p>We then call the CLIP method to grab the features, or vector embeddings, associated
with the images in our list. We also convert these embeddings from torch tensors to
numpy arrays to enable their use in svs.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generating embeddings&#39;</span><span class="p">)</span>
    <span class="n">embeddings</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_image_features</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="use-or-save-the-embeddings">
<h4>Use or save the embeddings<a class="headerlink" href="#use-or-save-the-embeddings" title="Link to this heading"></a></h4>
<p>Now that you have the embeddings as numpy arrays, you can directly pass them as
inputs to svs functions. An example call to build a search index from the
embeddings is shown below.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">index</span> <span class="o">=</span> <span class="n">svs</span><span class="o">.</span><span class="n">Vamana</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">svs</span><span class="o">.</span><span class="n">DistanceType</span><span class="o">.</span><span class="n">L2</span><span class="p">)</span>
</pre></div>
</div>
<p>You may also save the embeddings into the commonly used vector file format <code class="docutils literal notranslate"><span class="pre">*vecs</span></code>
with <a class="reference internal" href="python/common.html#svs.write_vecs" title="svs.write_vecs"><code class="xref py py-func docutils literal notranslate"><span class="pre">svs.write_vecs()</span></code></a>. A description of the <code class="docutils literal notranslate"><span class="pre">*vecs</span></code> file format is given
<a class="reference external" href="http://corpus-texmex.irisa.fr/">here</a>.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">svs</span><span class="o">.</span><span class="n">write_vecs</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>
</pre></div>
</div>
<p>Other data format helper functions are described in our <a class="reference external" href="https://intel.github.io/ScalableVectorSearch/io.html">I/O and Conversion Tools</a> documentation.</p>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="features.html" class="btn btn-neutral float-left" title="Library Features" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="io.html" class="btn btn-neutral float-right" title="I/O and Conversion Tools" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Intel Corporation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>